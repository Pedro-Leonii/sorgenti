name: Inserisce le issue per cui Ã¨ stata aperta una pull request nella colonna review della project board

on: 
  pull_request:
    types: [opened, reopened]
  
jobs:
  move_issue:
     if: startsWith(github.head_ref, 'feature/') and 
     runs-on: ubuntu-latest
     env:
       GH_TOKEN: ${{ github.token }}
       PROJECT_ID: ${{ secrets.PROJECT_ID }}
       STATUS_FIELD_ID: ${{ github.STATUS_FIELD }}
       REVIEW_VALUE_ID: ${{ github.VALUE_REVIEW_ID }}
       
     steps:   
      - name: setup gh
        run: sudo apt-get install gh
  
      - name: clone repo
        run: | 
          gh repo clone https://github.com/Pedro-Leonii/sorgenti
          cd sorgenti
          
      - name: get issue id
        
        run: |
              issue_n=$(echo "${{github.head_ref}}" | grep -E -o -m 1 '([0-9]+)')
              issue_id=$(gh issue view $issue_id --json id --jq .id)
              echo "ISSUE_ID=$issue_id" >> $GITHUB_ENV
              
      - name: Early exit
        run: |
          if [ -z "${VAR}" ]
          do
            echo "Id della issue del feature branch non esiste"
            gh run cancel ${{ github.run_id }}
            gh run watch ${{ github.run_id }}
          done
          
      - name: Change issue status to review
        run: |
          gh project item-edit --id $ISSUE_ID --field-id $STATUS_FIELD_ID --project-id $PROJECT_ID --single-select-option-id $REVIEW_VALUE_ID
        
