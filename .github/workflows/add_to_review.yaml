name: Inserisce le issue per cui Ã¨ stata aperta una pull request nella colonna review della project board

on: 
  pull_request:
    types: [closed]
  
jobs:
  move_issue:
     if: startsWith(github.head_ref, 'feature/') 
     runs-on: ubuntu-latest
     env:
       PROJECT_NAME: "Prova"
       GH_TOKEN: ${{ secrets.PAT_COMPILATI }}
       
     steps:   
        - name: setup gh
          run: sudo apt-get install gh
    
        - name: clone repo
          run: | 
            gh repo clone https://github.com/Pedro-Leonii/sorgenti
        
        - name: get project number
          working-directory: sorgenti
          run: |
            project_number=$(gh project list --format json | jq '.projects[] | select(.title=="Prova") | .number')
            echo "PROJECT_NUMBER=$project_number" >> $GITHUB_ENV
            
        - name: get issue id
          working-directory: sorgenti
          run: |
            issue_number=$(echo "${{github.head_ref}}" | grep -E -o -m 1 '[0-9]+')
            issue_id=$(gh project item-list ${{ env.PROJECT_NUMBER }} --owner @me --format json --jq ".items[] | select(.content.number==$issue_number) | .id")
            echo "$issue_id"
            echo "$issue_number"
            echo "ISSUE_ID=$issue_id" >> $GITHUB_ENV
            
        - name: get project id
          working-directory: sorgenti
          run: |
            project_id=$(gh project list --format json | jq ".projects[] | select(.number==${{ env.PROJECT_NUMBER }}) | .id")
            echo "PROJECT_ID=$project_id" >> $GITHUB_ENV
        
        - name: Change issue status to review
          working-directory: sorgenti
          run: |
            review_value_id=$(gh project field-list ${{ env.PROJECT_NUMBER }} --owner @me --format json --jq '.fields[] | select(.name=="Status") | .options[] | select(.name=="To do") | .id')
            field_status_id=$(gh project field-list ${{ env.PROJECT_NUMBER }} --owner @me --format json --jq '.fields[] | select(.name=="Status") | .id')
            gh project item-edit --id ${{ env.ISSUE_ID }} --field-id $field_status_id --project-id ${{ env.PROJECT_ID }} --single-select-option-id $review_value_id
          
